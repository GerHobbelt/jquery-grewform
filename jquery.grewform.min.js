/*
 * jQuery GrewForm Plugin v0.0.3
 *
 * Copyright 2011, Artem Suschev
 * Grandcapital Ltd.
 *  
 * Licensed under the MIT license (license.txt)
 */
jQuery.fn.grewform=function(b){jQuery("input,textarea").live("keyup change",function(g){var f=[33,34,36,35,45,38,40,37,39];if(g.keyCode&&jQuery.inArray(g.keyCode,f)<0){jQuery(this).attr("value",this.value)}});var c=this;for(var a in b){var d=new Rule(a,c,b[a])}c.find("*").keyup(function(){var e=setInterval(function(){clearInterval(e);run_rules()},300)});jQuery(document).ready(function(){run_rules()});return c.find("*").change(function(){run_rules()})};function debug(a){}function run_rules(){jQuery.each(Rule.all,function(a,b){(function(d){var c=setInterval(function(){try{if(!Rule.form.find("*").is(":animated")){clearInterval(c);if(d.unmatches()){d.run_unmatch_actions()}}}catch(f){clearInterval(c)}},200)}(b))});jQuery.each(Rule.all,function(a,b){(function(d){var c=setInterval(function(){try{if(!Rule.form.find("*").is(":animated")){clearInterval(c);if(d.matches()){d.run_match_actions()}}}catch(f){clearInterval(c)}},200)}(b))})}function Rule(b,d,a){if(typeof Rule.id=="undefined"){Rule.id=0;Rule.blip_ptr="hgo_grewform_rule";Rule.unmtach_by_blip=function(e){jQuery.each(Rule.all,function(f,g){if(g.blip===e){g.run_unmatch_actions()}})};Rule.all=[];Rule.form=d}this.id=Rule.id;Rule.id=Rule.id+1;this.blip=Rule.blip_ptr+this.id;this.selectors=arrayfy((""+b).split("AND"));jQuery.each(this.selectors,function(e){return function(g,f){e[g]=jQuery.trim(""+f)}}(this.selectors));this.selector=arr_to_selector(this.selectors);this.trigged=false;this.match_actions=[];this.unmatch_actions=[];this.raw=a;this.raw_selector=b;for(var c in a){generate_actions(c,d,this)}this.matches=function(){for(var f=0;f<this.selectors.length;f++){var e=this.selectors[f];if((!this.trigged)){if(Rule.form.find(e).filter("option:first").length>0){if(Rule.form.find(e).parent("select:visible:first").length===0){return false}}else{if(Rule.form.find(e).filter(":visible:first").length===0){return false}}}else{return false}}return true};this.unmatches=function(){if(!this.trigged){return false}for(var f=0;f<this.selectors.length;f++){var e=this.selectors[f];if(Rule.form.find(e+":first").length===0){return true}}return false};this.run_match_actions=function(){debug("match: "+this.raw_selector);this.trigged=true;Rule.form.find(this.selector).addClass(this.blip);for(var e=0;e<this.match_actions.length;e++){var f=this.match_actions[e];f.call(this)}};this.run_match_actions.first_run=true;this.run_unmatch_actions=function(){debug("unmatch: "+this.raw_selector);this.trigged=false;jQuery("."+this.blip).removeClass(this.blip);for(var e=0;e<this.unmatch_actions.length;e++){var f=this.unmatch_actions[e];f.call(this)}};Rule.all.push(this)}function generate_actions(d,e,f){switch(d){case"show":f.match_actions.push(function(g){return function(){if(g.is("option")){g.show()}else{g.slideDown()}}}(e.find(f.raw[d])));f.unmatch_actions.push(function(g){return function(){cascade_unmatch(g);if(g.is("option")){g.hide()}else{g.slideUp()}}}(e.find(f.raw[d])));break;case"hide":f.match_actions.push(function(g){return function(){if(g.is("option")){g.hide()}else{g.slideUp()}}}(e.find(f.raw[d])));f.unmatch_actions.push(function(g){return function(){cascade_unmatch(g);if(g.is("option")){g.show()}else{g.slideDown()}}}(e.find(f.raw[d])));break;case"set_value":f.match_actions.push(function(g){return function(){var h=this;jQuery.each(g,function(i,j){jQuery.each(Rule.form.find(i),function(){var k=jQuery(this).tagName;if(k=="select"){elems.find("option").removeAttr("selected");elems.find("option [value="+j+"]").attr("selected","selected")}else{jQuery(this).val(j)}})})}}(f.raw[d]));break;case"add_options":for(var a in f.raw[d]){var c=f.raw[d][a];if(typeof c=="function"){f.match_actions.push(function(i,g,h){return function(){var k=h();for(var j in k){var l=i.find(g);jQuery("<option></option>").html(k[j]).val(j).appendTo(l)}if(this.run_match_actions.first_run){for(var j in k){this.unmatch_actions.push(function(o,m,n){return function(){cascade_unmatch(o.children(m).children("option[value="+n+"]"));o.find(m).children().remove("option[value="+n+"]")}}(e,g,j))}this.run_match_actions.first_run=false}}}(e,a,c))}else{for(var b in c){f.match_actions.push(function(k,g,i,j){return function(){var h=k.find(g);jQuery("<option></option>").html(j).val(i).appendTo(h)}}(e,a,b,c[b]));f.unmatch_actions.push(function(i,g,h){return function(){cascade_unmatch(i.children(g).children("option[value="+h+"]"));i.find(g).children().remove("option[value="+h+"]")}}(e,a,b))}}}break;case"disable":f.match_actions.push(function(g){return function(){g.attr("disabled","disabled")}}(e.find(f.raw[d])));f.unmatch_actions.push(function(g){return function(){cascade_unmatch(g);g.removeAttr("disabled")}}(e.find(f.raw[d])));break;case"enable":f.match_actions.push(function(g){return function(){g.removeAttr("disabled")}}(e.find(f.raw[d])));f.unmatch_actions.push(function(g){return function(){cascade_unmatch(g);g.attr("disabled","disabled")}}(e.find(f.raw[d])));break;case"check":f.match_actions.push(function(g){return function(){g.attr("checked","checked")}}(e.find(f.raw[d])));f.unmatch_actions.push(function(g){return function(){cascade_unmatch(g);g.removeAttr("checked")}}(e.find(f.raw[d])));break;case"uncheck":f.match_actions.push(function(g){return function(){g.removeAttr("checked")}}(e.find(f.raw[d])));f.unmatch_actions.push(function(g){return function(){cascade_unmatch(g);g.attr("checked","checked")}}(e.find(f.raw[d])));break;case"custom":f.match_actions.push(function(h,g){return function(){h.call(g)}}(f.raw[d]["match"],jQuery(f.selector)));f.unmatch_actions.push(function(h,g){return function(){h.call(g)}}(f.raw[d]["unmatch"],jQuery(f.selector)));break;default:return}}function cascade_unmatch(a){jQuery.each(a,function(c,b){if(jQuery(this).attr("class")!==undefined){var d=jQuery(this).attr("class").split(" ")}else{return}jQuery.each(d,function(f,e){Rule.unmtach_by_blip(e)});cascade_unmatch(a.children())})}function arrayfy(a){if(a.constructor!==Array){return[a]}return a}function arr_to_selector(a){res="";for(var b=0;b<a.length;b++){res+=jQuery.trim(""+a[b])+","}return res};